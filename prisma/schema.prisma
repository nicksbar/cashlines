// Cashlines: Personal Money Tracking
// Tracks income, transactions, and money routing across accounts.
// Single-user first, multi-user ready via User model.

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User model for future multi-user support
model User {
  id    String @id @default(cuid())
  name  String?
  email String @unique
  
  // Data protection: prevents accidental data loss when working with real data
  isProduction Boolean @default(false) // Set to true to prevent resets via UI
  
  accounts           Account[]
  incomes            Income[]
  transactions       Transaction[]
  rules              Rule[]
  templates          Template[]
  people             Person[]
  settings           Setting?
  recurringExpenses  RecurringExpense[]
  balanceSnapshots   BalanceSnapshot[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Person: Household member for categorizing income and expenses
model Person {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  name  String
  role  String? // "primary", "spouse", "child", "dependent", "other" - for tracking context
  color String? // Hex color for UI display (#FF5733)
  
  accounts           Account[]
  incomes            Income[]
  transactions       Transaction[]
  recurringExpenses  RecurringExpense[]
  templates          Template[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@unique([userId, name])
  @@index([userId])
}

// Account: Represents a funding source or destination (checking, savings, CC, cash, etc.)
model Account {
  id       String @id @default(cuid())
  userId   String
  user     User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  personId String?
  person   Person? @relation(fields: [personId], references: [id], onDelete: SetNull)
  
  name     String
  type     String // "checking", "savings", "credit_card", "cash", "investment", "loan", "other"
  isActive Boolean @default(true)
  notes    String?
  
  // Credit Card specific fields
  creditLimit      Float?   // Optional: for credit cards and lines of credit
  interestRate     Float?   // Annual percentage rate (APR)
  cashBackPercent  Float?   // Cash back percentage (e.g., 1.5 for 1.5%)
  pointsPerDollar  Float?   // Points earned per $1 spent
  annualFee        Float?   // Annual fee if applicable
  rewardsProgram   String?  // Name of rewards program
  
  // Savings/Checking account fields
  interestRateApy  Float?   // Annual Percentage Yield for savings/checking
  monthlyFee       Float?   // Monthly maintenance fee
  minimumBalance   Float?   // Minimum balance requirement
  isFdic           Boolean? // FDIC insured (savings/checking)
  
  // Cash account fields
  location         String?  // Where cash is stored (wallet, safe, etc.)
  
  // Investment/Loan account fields
  principalBalance Float?   // For loans - remaining principal
  currentBalance   Float?   // Current account balance (snapshot, updated manually)
  accountNumber    String?  // Account identifier (masked for security)
  
  // Balance tracking
  balanceSnapshots BalanceSnapshot[]
  
  incomes           Income[]
  transactions      Transaction[]
  templates         Template[] @relation("TemplateAccount")
  recurringExpenses RecurringExpense[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@unique([userId, name])
  @@index([userId])
  @@index([type])
}

// BalanceSnapshot: Track account balance over time for interest/growth calculations
model BalanceSnapshot {
  id        String @id @default(cuid())
  userId    String
  user      User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  accountId String
  account   Account @relation(fields: [accountId], references: [id], onDelete: Cascade)
  
  snapshotDate DateTime // Date of the snapshot
  balance      Float    // Balance at this date
  notes        String?  // Optional notes about this snapshot
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([userId])
  @@index([accountId])
  @@index([snapshotDate])
  @@unique([accountId, snapshotDate])
}

// Income: Money flowing in (salary, freelance, transfers, etc.)
model Income {
  id        String @id @default(cuid())
  userId    String
  user      User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  personId  String?
  person    Person? @relation(fields: [personId], references: [id], onDelete: SetNull)
  
  accountId String
  account   Account @relation(fields: [accountId], references: [id], onDelete: Restrict)
  
  date                 DateTime
  grossAmount          Float    // Pre-tax amount
  taxes                Float    // Total taxes withheld
  preTaxDeductions     Float    // 401k, health insurance, etc.
  postTaxDeductions    Float    // Additional post-tax deductions
  netAmount            Float    // What actually deposits (gross - taxes - deductions)
  source               String   // e.g., "Salary", "Freelance", "Refund"
  notes                String?
  tags                 String   // JSON array stored as string: ["tax:w2", "recurring"]
  
  rules Rule[] // Reference to rules that match this income for auto-splits
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([userId])
  @@index([personId])
  @@index([accountId])
  @@index([date])
  @@index([source])
}

// Transaction: Money flowing out
model Transaction {
  id          String @id @default(cuid())
  userId      String
  user        User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  personId    String?
  person      Person? @relation(fields: [personId], references: [id], onDelete: SetNull)
  
  accountId   String
  account     Account @relation(fields: [accountId], references: [id], onDelete: Restrict)
  
  date        DateTime
  amount      Float
  description String
  method      String // "cc", "cash", "ach", "other"
  notes       String?
  tags        String // JSON array: ["groceries", "recurring"]
  websiteUrl  String? // Link to merchant/vendor website
  
  splits Split[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([userId])
  @@index([personId])
  @@index([accountId])
  @@index([date])
  @@index([method])
}

// Split: How a transaction is categorized/routed (need, want, debt, tax, savings, etc.)
model Split {
  id            String @id @default(cuid())
  transactionId String
  transaction   Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  
  type      String  // "need", "want", "debt", "tax", "savings", "other"
  target    String  // e.g., "Amex", "Emergency Fund", "Federal Tax"
  amount    Float?  // absolute amount (if not percentage)
  percent   Float?  // percentage of transaction amount (if not absolute)
  notes     String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([transactionId])
  @@index([type])
}

// Rule: Routing rules for auto-splitting income or transactions
model Rule {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  name   String
  
  // Match criteria
  matchSource       String?  // regex pattern to match income source
  matchDescription  String?  // regex pattern to match transaction description
  matchAccountId    String?  // specific account ID
  matchMethod       String?  // specific method: "cc", "cash", "ach", "other"
  matchTags         String?  // JSON array of tags to match
  
  // Split configuration (JSON stored as string for flexibility)
  splitConfig String // JSON: [{ type: "need", target: "...", percent: 50 }, ...]
  
  isActive Boolean @default(true)
  notes    String?
  
  matchedIncomes Income[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([userId])
  @@index([isActive])
}

// Optional: Tag model for future tag management UI
model Tag {
  id    String @id @default(cuid())
  name  String @unique
  
  createdAt DateTime @default(now())
}

// Template models for quick creation of common entries
model Template {
  id   String @id @default(cuid())
  type String // "transaction" or "income"
  
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  personId String?
  person   Person? @relation(fields: [personId], references: [id], onDelete: SetNull)
  
  // Basic info
  name        String
  description String?
  
  // Transaction fields
  amount          Float?    // for transactions or income gross
  method          String?   // "cc", "cash", "ach", "other"
  accountId       String?
  account         Account?  @relation("TemplateAccount", fields: [accountId], references: [id], onDelete: SetNull)
  
  // Income fields
  grossAmount      Float?
  federalTaxes     Float?
  stateTaxes       Float?
  socialSecurity   Float?
  medicare         Float?
  preDeductions    Float?
  postDeductions   Float?
  
  // Shared template data (JSON strings for flexibility)
  tags        String?       // JSON: ["tag1", "tag2"]
  notes       String?       // Additional notes
  splits      String?       // JSON: [{ type: "need", target: "...", percent: 100 }]
  
  // Template metadata
  isFavorite  Boolean @default(false)
  usageCount  Int @default(0)
  lastUsedAt  DateTime?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([userId])
  @@index([type])
  @@index([isFavorite])
}

// Settings: User goals, targets, and budget settings
model Setting {
  id    String @id @default(cuid())
  userId String
  user  User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Budget targets
  monthlyIncomeTarget      Float?  // Goal monthly income
  monthlyExpenseTarget     Float?  // Target max expenses
  savingsTarget            Float?  // Monthly savings goal
  savingsRate              Float?  // Target savings rate (0-100%)
  
  // Allocation targets (50/30/20 rule)
  needPercent              Float @default(50)   // Target % for needs
  wantPercent              Float @default(30)   // Target % for wants
  savingsPercent           Float @default(20)   // Target % for savings
  
  // Thresholds and alerts
  lowBalanceThreshold      Float?  // Alert if checking < this
  highCreditCardThreshold  Float?  // Alert if CC balance > this
  
  // Categories and tracking
  trackedCategories        String  // JSON: ["Housing", "Food", "Transport"]
  excludeFromBudget        String  // JSON: ["Transfer", "Internal"]
  
  // Preferences
  currency                 String @default("USD")
  fiscalYearStart          Int @default(1)    // Month 1-12
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@unique([userId])
  @@index([userId])
}

// RecurringExpense: Track fixed/recurring bills and expenses
model RecurringExpense {
  id       String @id @default(cuid())
  userId   String
  user     User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  personId String?
  person   Person? @relation(fields: [personId], references: [id], onDelete: SetNull)
  
  accountId String?
  account   Account? @relation(fields: [accountId], references: [id], onDelete: SetNull)
  
  description    String   // e.g., "T-Mobile Bill", "Rent", "Insurance"
  amount         Float    // Recurring amount
  frequency      String   // "daily", "weekly", "monthly", "quarterly", "semi-annual", "yearly"
  dueDay         Int?     // Day of month for monthly expenses (1-31)
  nextDueDate    DateTime // Next expected charge date
  isActive       Boolean @default(true)
  notes          String?
  websiteUrl     String?  // Link to bill payment or vendor website
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([userId])
  @@index([personId])
  @@index([accountId])
  @@index([isActive])
  @@index([nextDueDate])
}