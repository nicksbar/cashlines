// Cashlines: Personal Money Tracking
// Tracks income, transactions, and money routing across accounts.
// Single-user first, multi-user ready via User model.

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// User model for future multi-user support
model User {
  id    String @id @default(cuid())
  name  String?
  email String @unique
  
  // Data protection: prevents accidental data loss when working with real data
  isProduction Boolean @default(false) // Set to true to prevent resets via UI
  
  accounts     Account[]
  incomes      Income[]
  transactions Transaction[]
  rules        Rule[]
  templates    Template[]
  people       Person[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Person: Household member for categorizing income and expenses
model Person {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  name  String
  role  String? // "primary", "spouse", "child", "dependent", "other" - for tracking context
  color String? // Hex color for UI display (#FF5733)
  
  accounts     Account[]
  incomes      Income[]
  transactions Transaction[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@unique([userId, name])
  @@index([userId])
}

// Account: Represents a funding source or destination (checking, savings, CC, cash, etc.)
model Account {
  id       String @id @default(cuid())
  userId   String
  user     User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  personId String?
  person   Person? @relation(fields: [personId], references: [id], onDelete: SetNull)
  
  name     String
  type     String // "checking", "savings", "credit_card", "cash", "other"
  isActive Boolean @default(true)
  notes    String?
  creditLimit Float? // Optional: for credit cards and lines of credit
  
  incomes      Income[]
  transactions Transaction[]
  templates    Template[] @relation("TemplateAccount")
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@unique([userId, name])
  @@index([userId])
  @@index([type])
}

// Income: Money flowing in (salary, freelance, transfers, etc.)
model Income {
  id        String @id @default(cuid())
  userId    String
  user      User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  personId  String?
  person    Person? @relation(fields: [personId], references: [id], onDelete: SetNull)
  
  accountId String
  account   Account @relation(fields: [accountId], references: [id], onDelete: Restrict)
  
  date                 DateTime
  grossAmount          Float    // Pre-tax amount
  taxes                Float    // Total taxes withheld
  preTaxDeductions     Float    // 401k, health insurance, etc.
  postTaxDeductions    Float    // Additional post-tax deductions
  netAmount            Float    // What actually deposits (gross - taxes - deductions)
  source               String   // e.g., "Salary", "Freelance", "Refund"
  notes                String?
  tags                 String   // JSON array stored as string: ["tax:w2", "recurring"]
  
  rules Rule[] // Reference to rules that match this income for auto-splits
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([userId])
  @@index([personId])
  @@index([accountId])
  @@index([date])
  @@index([source])
}

// Transaction: Money flowing out
model Transaction {
  id          String @id @default(cuid())
  userId      String
  user        User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  personId    String?
  person      Person? @relation(fields: [personId], references: [id], onDelete: SetNull)
  
  accountId   String
  account     Account @relation(fields: [accountId], references: [id], onDelete: Restrict)
  
  date        DateTime
  amount      Float
  description String
  method      String // "cc", "cash", "ach", "other"
  notes       String?
  tags        String // JSON array: ["groceries", "recurring"]
  
  splits Split[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([userId])
  @@index([personId])
  @@index([accountId])
  @@index([date])
  @@index([method])
}

// Split: How a transaction is categorized/routed (need, want, debt, tax, savings, etc.)
model Split {
  id            String @id @default(cuid())
  transactionId String
  transaction   Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  
  type      String  // "need", "want", "debt", "tax", "savings", "other"
  target    String  // e.g., "Amex", "Emergency Fund", "Federal Tax"
  amount    Float?  // absolute amount (if not percentage)
  percent   Float?  // percentage of transaction amount (if not absolute)
  notes     String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([transactionId])
  @@index([type])
}

// Rule: Routing rules for auto-splitting income or transactions
model Rule {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  name   String
  
  // Match criteria
  matchSource       String?  // regex pattern to match income source
  matchDescription  String?  // regex pattern to match transaction description
  matchAccountId    String?  // specific account ID
  matchMethod       String?  // specific method: "cc", "cash", "ach", "other"
  matchTags         String?  // JSON array of tags to match
  
  // Split configuration (JSON stored as string for flexibility)
  splitConfig String // JSON: [{ type: "need", target: "...", percent: 50 }, ...]
  
  isActive Boolean @default(true)
  notes    String?
  
  matchedIncomes Income[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([userId])
  @@index([isActive])
}

// Optional: Tag model for future tag management UI
model Tag {
  id    String @id @default(cuid())
  name  String @unique
  
  createdAt DateTime @default(now())
}

// Template models for quick creation of common entries
model Template {
  id   String @id @default(cuid())
  type String // "transaction" or "income"
  
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Basic info
  name        String
  description String?
  
  // Transaction fields
  amount          Float?    // for transactions or income gross
  method          String?   // "cc", "cash", "ach", "other"
  accountId       String?
  account         Account?  @relation("TemplateAccount", fields: [accountId], references: [id], onDelete: SetNull)
  
  // Income fields
  grossAmount      Float?
  federalTaxes     Float?
  stateTaxes       Float?
  socialSecurity   Float?
  medicare         Float?
  preDeductions    Float?
  postDeductions   Float?
  
  // Shared template data (JSON strings for flexibility)
  tags        String?       // JSON: ["tag1", "tag2"]
  notes       String?       // Additional notes
  
  // Template metadata
  isFavorite  Boolean @default(false)
  usageCount  Int @default(0)
  lastUsedAt  DateTime?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([userId])
  @@index([type])
  @@index([isFavorite])
}
